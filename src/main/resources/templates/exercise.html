<!DOCTYPE html>
<html lang="ko" xmlns:layout="http://ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/layout}"
      layout:fragment="content">
<body>
<div class="container">
    <h2 class="text-center">운동 타이머</h2>
    <div class="text-center">
        <h3 id="timerDisplay">00:00</h3>
        <h5>남은 세트 수: <span id="remainingSets" th:text="${setting.sets}"></span></h5>
        <h5>진행 중인 세트 수: <span id="currentSet">1</span></h5>
        <h5>반복 수: <span id="reps" th:text="${setting.reps}"></span></h5>
        <h5>쉬는 시간: <span id="restTime" th:text="${setting.restTime}"></span>초</h5>
    </div>
    <div class="text-center mt-4">
        <button id="startWorkout" class="btn btn-success">운동 시작</button>
        <button id="endSetButton" class="btn btn-warning" style="display:none;">세트 종료</button>
        <button id="pauseButton" class="btn btn-danger" style="display:none;">일시 정지</button>
        <button id="endRestButton" class="btn btn-warning" style="display:none;">쉬는 시간 종료</button>
    </div>

    <div class="mt-4">
        <h5>각 세트별 운동 시간:</h5>
        <ul id="setTimesList"></ul>
        <h5>총 운동 시간: <span id="totalWorkoutTime">00:00</span></h5>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let sets = parseInt(document.getElementById("remainingSets").textContent);
        let reps = parseInt(document.getElementById("reps").textContent);
        let restTime = parseInt(document.getElementById("restTime").textContent);
        let currentSet = 1;
        let timerInterval;
        let timeElapsed = 0;
        let totalWorkoutTime = 0;
        let setTimes = [];
        let isPaused = false;
        let isResting = false;
        let remainingRestTime = restTime;

        const startWorkoutBtn = document.getElementById("startWorkout");
        const endSetBtn = document.getElementById("endSetButton");
        const pauseBtn = document.getElementById("pauseButton");
        const endRestBtn = document.getElementById("endRestButton");
        const resumeRestBtn = document.createElement("button");
        resumeRestBtn.textContent = "쉬는 시간 시작";
        resumeRestBtn.classList.add("btn", "btn-info");
        resumeRestBtn.style.display = "none";
        document.querySelector(".text-center.mt-4").appendChild(resumeRestBtn);

        startWorkoutBtn.addEventListener("click", function () {
            startWorkoutBtn.style.display = "none";
            endSetBtn.style.display = "inline-block";
            pauseBtn.style.display = "inline-block";

            if (isPaused) {
                isPaused = false;
                if (isResting) {
                    startRestTimer(remainingRestTime);
                } else {
                    startWorkoutTimer();
                }
            } else {
                startWorkoutTimer();
            }
        });

        pauseBtn.addEventListener("click", function () {
            clearInterval(timerInterval);
            isPaused = true;
            pauseBtn.style.display = "none";

            if (isResting) {
                resumeRestBtn.style.display = "inline-block";
            } else {
                startWorkoutBtn.style.display = "inline-block";
            }
        });

        resumeRestBtn.addEventListener("click", function () {
            isPaused = false;
            resumeRestBtn.style.display = "none";
            pauseBtn.style.display = "inline-block";
            startRestTimer(remainingRestTime);
        });

        endSetBtn.addEventListener("click", function () {
            clearInterval(timerInterval);
            setTimes.push(timeElapsed);
            totalWorkoutTime += timeElapsed;
            updateSetTimesList();
            document.getElementById("currentSet").textContent = currentSet;
            endSetBtn.style.display = "none";
            pauseBtn.style.display = "none";
            resetTimer();

            if (currentSet < sets) {
                startRestTimer(restTime);
            } else {
                alert("모든 세트가 완료되었습니다!");
                document.getElementById("totalWorkoutTime").textContent = formatTime(totalWorkoutTime);
            }
        });

        endRestBtn.addEventListener("click", function () {
            clearInterval(timerInterval);
            alert("쉬는 시간이 종료되었습니다. 다음 세트를 시작합니다!");
            timerDisplay.textContent = `00:00`;
            currentSet++;
            isResting = false;

            if (currentSet <= sets) {
                document.getElementById("currentSet").textContent = currentSet;
                endRestBtn.style.display = "none";
                startWorkoutTimer();
                endSetBtn.style.display = "inline-block";
                pauseBtn.style.display = "inline-block";
            } else {
                alert("모든 세트가 완료되었습니다!");
            }
        });

        function startWorkoutTimer() {
            clearInterval(timerInterval);
            isResting = false;
            timerInterval = setInterval(function () {
                timeElapsed++;
                updateTimerDisplay();
            }, 1000);
        }

        function startRestTimer(timeRemaining) {
            isResting = true;
            endRestBtn.style.display = "inline-block";
            pauseBtn.style.display = "inline-block";
            resumeRestBtn.style.display = "none";
            updateTimerDisplay(timeRemaining);

            timerInterval = setInterval(function () {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerDisplay(timeRemaining);
                    remainingRestTime = timeRemaining;
                } else {
                    clearInterval(timerInterval);
                    alert("쉬는 시간이 끝났습니다. 다음 운동을 시작하세요!");
                    endRestBtn.click();
                }
            }, 1000);
        }

        function updateTimerDisplay(remainingTime = null) {
            let minutes = Math.floor(timeElapsed / 60).toString().padStart(2, "0");
            let seconds = (timeElapsed % 60).toString().padStart(2, "0");
            timerDisplay.textContent = `${minutes}:${seconds}`;

            if (remainingTime !== null) {
                let restMinutes = Math.floor(remainingTime / 60).toString().padStart(2, "0");
                let restSeconds = (remainingTime % 60).toString().padStart(2, "0");
                timerDisplay.textContent = `${restMinutes}:${restSeconds}`;
            }
        }

        function updateSetTimesList() {
            let setTimesList = document.getElementById("setTimesList");
            setTimesList.innerHTML = "";
            setTimes.forEach((time, index) => {
                let minutes = Math.floor(time / 60).toString().padStart(2, "0");
                let seconds = (time % 60).toString().padStart(2, "0");
                let listItem = document.createElement("li");
                listItem.textContent = `세트 ${index + 1}: ${minutes}:${seconds}`;
                setTimesList.appendChild(listItem);
            });

            document.getElementById("totalWorkoutTime").textContent = formatTime(totalWorkoutTime);
        }

        function formatTime(totalSeconds) {
            let minutes = Math.floor(totalSeconds / 60).toString().padStart(2, "0");
            let seconds = (totalSeconds % 60).toString().padStart(2, "0");
            return `${minutes}:${seconds}`;
        }

        function resetTimer() {
            timeElapsed = 0;
        }
    });
</script>

</body>
</html>
