<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>운동 타이머</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center">운동 타이머</h2>
    <div class="text-center">
        <h3 id="timerDisplay">00:00</h3>
        <h5>남은 세트 수: <span id="remainingSets" th:text="${setting.sets}"></span></h5>
        <h5>진행 중인 세트 수: <span id="currentSet">1</span></h5>
        <h5>반복 수: <span id="reps" th:text="${setting.reps}"></span></h5>
        <h5>쉬는 시간: <span id="restTime" th:text="${setting.restTime}"></span>초</h5>
    </div>
    <div class="text-center mt-4">
        <button id="startWorkout" class="btn btn-success">운동 시작</button>
        <button id="endSetButton" class="btn btn-warning" style="display:none;">세트 종료</button>
        <button id="pauseButton" class="btn btn-danger" style="display:none;">일시 정지</button>
        <button id="endRestButton" class="btn btn-warning" style="display:none;">쉬는 시간 종료</button>
    </div>

    <div class="mt-4">
        <h5>각 세트별 운동 시간:</h5>
        <ul id="setTimesList"></ul>
        <h5>총 운동 시간: <span id="totalWorkoutTime">00:00</span></h5>
    </div>
</div>

<script th:inline="javascript">
    let sets = /*[[${setting.sets}]]*/ 5; // 서버에서 가져온 세트 수
    let reps = /*[[${setting.reps}]]*/ 10; // 서버에서 가져온 반복 수
    let restTime = /*[[${setting.restTime}]]*/ 60; // 서버에서 가져온 쉬는 시간
    let currentSet = 1;
    let timerInterval;
    let timeElapsed = 0; // 운동 시간 초기화
    let totalWorkoutTime = 0; // 총 운동 시간 초기화
    let setTimes = []; // 각 세트별 운동 시간을 저장하기 위한 배열

    $(document).ready(function () {
        $('#remainingSets').text(sets);
        $('#currentSet').text(currentSet);
        $('#restTime').text(restTime);

        $('#startWorkout').click(function () {
            $(this).hide();
            $('#endSetButton').show();
            $('#pauseButton').show();
            startWorkoutTimer();
        });

        $('#endSetButton').click(function () {
            clearInterval(timerInterval);
            setTimes.push(timeElapsed);
            totalWorkoutTime += timeElapsed;
            updateSetTimesList();
            $('#currentSet').text(currentSet);
            $(this).hide();
            resetTimer();

            // 마지막 세트인지 확인
            if (currentSet < sets) {
                startRestTimer();
            } else {
                alert('모든 세트가 완료되었습니다!');
                $('#totalWorkoutTime').text(formatTime(totalWorkoutTime)); // 총 운동 시간 표시
                $('#pauseButton').hide();
            }
        });

        $('#pauseButton').click(function () {
            clearInterval(timerInterval);
            $(this).hide();
            $('#startWorkout').show();
        });

        $('#endRestButton').click(function () {
            clearInterval(timerInterval);
            alert('쉬는 시간을 종료하고 다음 운동을 시작합니다!');
            $('#timerDisplay').text(`00:00`); // 타이머 초기화
            currentSet++;
            if (currentSet <= sets) {
                $('#currentSet').text(currentSet);
                $('#startWorkout').show();
            } else {
                alert('모든 세트가 완료되었습니다!');
            }
            $(this).hide(); // 쉬는 시간 종료 버튼 숨기기
        });
    });

    function startWorkoutTimer() {
        timeElapsed = 0; // 운동 시간 초기화
        $('#timerDisplay').text(`00:00`); // 타이머 초기화

        timerInterval = setInterval(function () {
            timeElapsed++;
            updateTimerDisplay();
        }, 1000);
    }

    function startRestTimer() {
        let timeRemaining = restTime; // 쉬는 시간 초기화
        updateTimerDisplay(timeRemaining);
        $('#endRestButton').show(); // 쉬는 시간 종료 버튼 표시

        timerInterval = setInterval(function () {
            if (timeRemaining > 0) {
                timeRemaining--;
                updateTimerDisplay(timeRemaining);
            } else {
                clearInterval(timerInterval);
                alert('쉬는 시간이 끝났습니다. 다음 운동을 시작하세요!');
                currentSet++;
                if (currentSet <= sets) {
                    $('#currentSet').text(currentSet);
                    $('#startWorkout').show();
                } else {
                    alert('모든 세트가 완료되었습니다!');
                }
                $('#endRestButton').hide(); // 쉬는 시간 종료 버튼 숨기기
            }
        }, 1000);
    }

    function updateTimerDisplay(remainingTime = null) {
        const minutes = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
        const seconds = (timeElapsed % 60).toString().padStart(2, '0');
        $('#timerDisplay').text(`${minutes}:${seconds}`);

        // 쉬는 시간 동안의 타이머 업데이트
        if (remainingTime !== null) {
            const restMinutes = Math.floor(remainingTime / 60).toString().padStart(2, '0');
            const restSeconds = (remainingTime % 60).toString().padStart(2, '0');
            $('#timerDisplay').text(`${restMinutes}:${restSeconds}`);
        }
    }

    function updateSetTimesList() {
        $('#setTimesList').empty(); // 기존 항목 삭제
        setTimes.forEach((time, index) => {
            const minutes = Math.floor(time / 60).toString().padStart(2, '0');
            const seconds = (time % 60).toString().padStart(2, '0');
            $('#setTimesList').append(`<li>세트 ${index + 1}: ${minutes}:${seconds}</li>`);
        });

        const totalMinutes = Math.floor(totalWorkoutTime / 60).toString().padStart(2, '0');
        const totalSeconds = (totalWorkoutTime % 60).toString().padStart(2, '0');
        $('#totalWorkoutTime').text(`${totalMinutes}:${totalSeconds}`);
    }

    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
    }

    function resetTimer() {
        timeElapsed = 0; // 운동 시간 초기화
    }
</script>
</body>
</html>
